---
title: "DielLightGrowthPeaks"
author:
- Douglas A. Campbell
- Sylwia Wilczewska-Wilinska
- Mireille Savoie
date: "`r format(Sys.Date())`"
bibliography: Prochlorococcus_O2_NPQ.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---
# Introduction - skeleton

This exploratory Rmd loads estimates of hourly and diel cumulative photon dose to cultures generated from PSI MC data file.

It plots timing of peaks of growth rates vs. peaks of PAR and ToD to detect shifts in timing with growth conditions & strain.

  
# Set Options

## Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

```{r libraries}
library(tidyverse)
library(zoo)

library(e1071)
library(gcookbook)  # Load gcookbook for the uspopage data set
#library(viridis)  # Load viridis for the viridis palette
library("RColorBrewer")
```

```{r colour setting}
# Bin4_nm <- c(440, 510, 590, 660)
# Bin4Colours <- c(w_length2rgb(440), w_length2rgb(510), w_length2rgb(590), w_length2rgb(660))
# names(Bin4Colours) <- Bin4_nm
```

```{r set project variables}
Project <- "PicoDiel"
DataOut <- file.path("..", "Data", "ProcessedData", "DielLightPeaks")

FigPath <- file.path("..", "Output", "Figures")
# FigRdsPath <- file.path("..", "Output", "FiguresRds")
# TableRdsPath <- file.path("..", "Output", "TablesRDS")
```



## Read Data


```{r read data}
DielData <- readRDS(file = file.path("..", "Data", "ProcessedData", "ProcessedMCDielLightData","DielLightGrowth.Rds"))
```


# Exploratory Plots from representative data file
```{r par_time_plot}
DielData |>
  filter(Run == 39) |>
  ggplot() +
  geom_point(aes(x = ToD, y = Actinic_par, colour = WL)) +
  facet_grid(cols = vars(Tube)) +
  theme_bw()


```




```{r preliminary plot}
DielData |>
  filter(Run == 39) %>% 
  filter(time >= 24,
          time <= 72) |>
  ggplot() +
  geom_point(aes(x = ToD, y = Actinic_umolphotonsm2h, colour = mu_Averh)) +
  geom_point(aes(x = time, y = OD720), colour = "green") +
  facet_grid(cols = vars(Photoperiod), rows = vars (Par_ue)) +
  theme_bw()
  
DielData |>
  filter(time >= 48,
         time <= 96) |>
  ggplot() +
  geom_point(aes(x = ToD, y = mu_Averh)) +
  geom_vline(aes(xintercept = 12)) + #hack for peak light ToD
  facet_grid(cols = vars(Par_ue), rows = vars (Photoperiod)) +
  theme_bw()  

DielData |>
  filter(time >= 48,
         time <= 96) |>
  ggplot() +
  geom_point(aes(x = time, y = mu_Averh)) +
  facet_grid(cols = vars(Par_ue), rows = vars (Photoperiod)) +
  theme_bw()  

```

## Apply filter to remove outlier points 
Think of a better way?
mu 1 d-1 ~ 0.042

```{r DielFilter}
DielFilter <- DielData |>
  filter(mu_Averh > -0.1,
         mu_Averh < 0.1)

DielFilter |>
  filter(time >= 24,
         time <= 120) |>
  ggplot() +
  geom_point(aes(x = time, y = mu_Averh)) +
  facet_grid(cols = vars(Par_ue), rows = vars (Photoperiod, Filename)) +
  theme_bw()  
```

# Implement time series analyses to detect timing of peaks?





# Estimate minium & maximum growth rate for each day
Issues here b/c hourly growth rate does not vary much through 24 h?
Noisy points overwhelm signal?
Need average firstly?
Also think about 'compensation point' where growth passes 0
Sylwia Runs 71, 74, 77 121 problematic

```{r minmax_growth}
#use nest or group_by?
# unique(DielData$Run)
#39  40  43  44  45  46  50  60  62  65  71  74  77 121

#errors estimating LightMaxToD

MaxMuLightData <- DielData |>
  filter(Run %in% c(39, 40, 43, 44, 45, 46, 50, 60, 62, 65,  71,  74, 77, 121)) |> 
  filter(time >= 24) |>
  filter(time < 48)  |>
  group_by(Filename, Photoperiod, Par_ue, Tube, Day) |>
  summarise(MinMu = min(mu_Averh, na.rm = TRUE),
         MaxMu = max(mu_Averh, na.rm = TRUE),
         MinMuToD = ToD[which(mu_Averh == MinMu)],
         MaxMuToD = ToD[which(mu_Averh == MaxMu)],
         LightMaxToD = 12, #hack to cope with continuous light runs
         deltaMaxMuLightToD = MaxMuToD - LightMaxToD
  ) |>
  ungroup()

# 
# |>
#   ungroup() |>
#   group_by(Filename, Tube) |>
#   mutate(MeanMaxMuToD = mean(MaxMuToD, na.rm = TRUE),
#          MeandeltaMaxMuLightToD = MeanMaxMuToD - LightMaxToD) |>
#   ungroup()

MaxMuLightData |>
  ggplot() +
  geom_point(aes(x = LightMaxToD, y  = MaxMuToD, colour = MaxMu)) +
  coord_cartesian(xlim = c(0, 24)) +
  facet_grid(cols = vars(Photoperiod), rows = vars(Par_ue)) +
  theme_bw()

MaxMuLightData |>
  ggplot() +
  geom_point(aes(x = Par_ue, y  = MaxMuToD, colour = MaxMu)) +
  geom_smooth(aes(x = Par_ue, y  = MaxMuToD), method  = "lm") +
  geom_hline(aes(yintercept = LightMaxToD)) +
  #coord_cartesian(xlim = c(0, 24)) +
  facet_grid(cols = vars(Photoperiod)) +
  theme_bw()



```




```{r save hourly growth peaks}
# add code with 'paste' to generate custom name later

# saveRDS(object = DielLightGrowth, file = file.path(DataOut, "DielLightGrowth.Rds"), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

```


